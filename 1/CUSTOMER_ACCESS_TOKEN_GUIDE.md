# Customer Access Token Guide

This guide explains where `customerAccessToken` comes from, how it's generated, and how to obtain it in your Shopify storefront.

## What is customerAccessToken?

`customerAccessToken` is a token generated by Shopify that authenticates a customer for the Storefront API. It's used to:
- Fetch customer data (orders, account info)
- Update customer information
- Access customer-specific resources

## How Customer Access Token is Generated

### 1. Customer Login/Registration

When a customer logs in or registers on Shopify, Shopify generates the `customerAccessToken` using the **Storefront API**.

#### Method 1: Using Storefront API (customerAccessTokenCreate)

**Login Mutation:**
```graphql
mutation customerAccessTokenCreate($input: CustomerAccessTokenCreateInput!) {
  customerAccessTokenCreate(input: $input) {
    customerAccessToken {
      accessToken
      expiresAt
    }
    customerUserErrors {
      code
      field
      message
    }
  }
}
```

**Variables:**
```json
{
  "input": {
    "email": "customer@example.com",
    "password": "customer_password"
  }
}
```

**Response:**
```json
{
  "data": {
    "customerAccessTokenCreate": {
      "customerAccessToken": {
        "accessToken": "shpat_customer_token_here",
        "expiresAt": "2024-12-31T23:59:59Z"
      },
      "customerUserErrors": []
    }
  }
}
```

#### Method 2: Customer Registration (customerCreate)

```graphql
mutation customerCreate($input: CustomerCreateInput!) {
  customerCreate(input: $input) {
    customer {
      id
      email
    }
    customerAccessToken {
      accessToken
      expiresAt
    }
    customerUserErrors {
      code
      field
      message
    }
  }
}
```

**Variables:**
```json
{
  "input": {
    "email": "customer@example.com",
    "password": "customer_password",
    "firstName": "John",
    "lastName": "Doe"
  }
}
```

**Response includes:**
```json
{
  "data": {
    "customerCreate": {
      "customerAccessToken": {
        "accessToken": "shpat_customer_token_here",
        "expiresAt": "2024-12-31T23:59:59Z"
      }
    }
  }
}
```

## Where Customer Access Token is Stored

### 1. **Cookies** (Most Common)

Shopify automatically stores the token in cookies when using:
- **Customer Account API** (new authentication system)
- **Storefront API customer mutations**

**Cookie name:** `customerAccessToken` or `__customer_access_token`

**Example:**
```javascript
// Get from cookie
function getCustomerAccessToken() {
  const cookies = document.cookie.split(';');
  for (let cookie of cookies) {
    const [name, value] = cookie.trim().split('=');
    if (name === 'customerAccessToken' || name === '__customer_access_token') {
      return decodeURIComponent(value);
    }
  }
  return null;
}
```

### 2. **localStorage** (If manually stored)

Some implementations store it in localStorage:

```javascript
// Store after login
localStorage.setItem('customerAccessToken', token);

// Retrieve
const token = localStorage.getItem('customerAccessToken');
```

### 3. **Session Storage** (Temporary)

For temporary storage:

```javascript
sessionStorage.setItem('customerAccessToken', token);
const token = sessionStorage.getItem('customerAccessToken');
```

## How to Get Customer Access Token in Different Contexts

### Context 1: Shopify Storefront (JavaScript/Liquid)

#### Option A: From Customer Account API (Recommended for New Stores)

If your store uses the new Customer Account API:

```javascript
// The token is automatically stored in cookie by Shopify
async function getCustomerAccessTokenFromCookie() {
  const cookies = document.cookie.split(';');
  for (let cookie of cookies) {
    const [name, value] = cookie.trim().split('=');
    if (name === 'customerAccessToken' || name === '__customer_access_token') {
      return decodeURIComponent(value);
    }
  }
  return null;
}

// Usage
const token = getCustomerAccessTokenFromCookie();
if (token) {
  // Use token to make authenticated requests
  const response = await fetch('/apps/xwan-ai-sso/check-login', {
    headers: {
      'X-Customer-Access-Token': token
    }
  });
}
```

#### Option B: From Liquid Template (For Traditional Stores)

If using legacy customer accounts, you may not have a token. Instead, use customer data directly:

```liquid
{% if customer %}
  <script>
    // Customer is logged in, but may not have access token
    // Use customer data directly from Liquid
    const customerData = {
      email: '{{ customer.email | escape }}',
      id: '{{ customer.id }}',
      firstName: '{{ customer.first_name | escape }}',
      lastName: '{{ customer.last_name | escape }}'
    };
    
    // Redirect with customer data
    window.location.href = `/apps/xwan-ai-sso/sso?customer_email=${encodeURIComponent(customerData.email)}&customer_id=${customerData.id}&first_name=${encodeURIComponent(customerData.firstName)}&last_name=${encodeURIComponent(customerData.lastName)}`;
  </script>
{% endif %}
```

#### Option C: Custom Login Form with Storefront API

Create a custom login form that generates the token:

```html
<!-- Custom Login Form -->
<form id="customerLoginForm">
  <input type="email" id="email" placeholder="Email" required>
  <input type="password" id="password" placeholder="Password" required>
  <button type="submit">Login</button>
</form>

<script>
document.getElementById('customerLoginForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  const shopDomain = 'your-shop.myshopify.com';
  
  // Generate customer access token
  const query = `
    mutation customerAccessTokenCreate($input: CustomerAccessTokenCreateInput!) {
      customerAccessTokenCreate(input: $input) {
        customerAccessToken {
          accessToken
          expiresAt
        }
        customerUserErrors {
          code
          field
          message
        }
      }
    }
  `;
  
  const variables = {
    input: {
      email,
      password
    }
  };
  
  try {
    const response = await fetch(`https://${shopDomain}/api/2026-01/graphql.json`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Shopify-Storefront-Access-Token': 'YOUR_STOREFRONT_ACCESS_TOKEN'
      },
      body: JSON.stringify({ query, variables })
    });
    
    const data = await response.json();
    
    if (data.data.customerAccessTokenCreate.customerAccessToken) {
      const token = data.data.customerAccessTokenCreate.customerAccessToken.accessToken;
      
      // Store token in cookie
      document.cookie = `customerAccessToken=${token}; path=/; max-age=${60 * 60 * 24 * 30}; SameSite=Lax`;
      
      // Or store in localStorage
      localStorage.setItem('customerAccessToken', token);
      
      // Now you can use the token
      redirectToXwanAI(token);
    } else {
      // Handle errors
      console.error('Login failed:', data.data.customerAccessTokenCreate.customerUserErrors);
    }
  } catch (error) {
    console.error('Login error:', error);
  }
});

function redirectToXwanAI(token) {
  // Use the token to check login and redirect
  fetch(`/apps/xwan-ai-sso/check-login?customer_access_token=${token}`, {
    method: 'GET',
    credentials: 'include'
  })
  .then(response => response.json())
  .then(data => {
    if (data.isLoggedIn) {
      window.location.href = data.redirectUrl;
    }
  });
}
</script>
```

### Context 2: App Proxy Endpoint (Server-Side)

In your App Proxy route, get the token from:

1. **Query Parameter:**
```typescript
const token = url.searchParams.get("customer_access_token");
```

2. **HTTP Header:**
```typescript
const token = request.headers.get("X-Customer-Access-Token");
```

3. **Cookie:**
```typescript
const cookies = request.headers.get("cookie") || "";
const cookieMatch = cookies.match(/customerAccessToken=([^;]+)/);
const token = cookieMatch ? cookieMatch[1] : null;
```

### Context 3: Liquid Template (No Token, Use Customer Object)

For Liquid templates, you typically don't have direct access to the token. Instead, use the `customer` object:

```liquid
{% if customer %}
  <!-- Customer is logged in -->
  <a href="/apps/xwan-ai-sso/sso?customer_email={{ customer.email | url_param_escape }}&customer_id={{ customer.id }}&first_name={{ customer.first_name | url_param_escape }}&last_name={{ customer.last_name | url_param_escape }}">
    Go to XWAN.AI
  </a>
{% else %}
  <!-- Customer not logged in -->
  <a href="/account/login">Login</a>
{% endif %}
```

## Complete Example: Getting Token and Using It

### Step 1: Customer Logs In (Storefront API)

```javascript
// Login and get token
async function loginCustomer(email, password) {
  const shopDomain = 'your-shop.myshopify.com';
  const storefrontAccessToken = 'YOUR_STOREFRONT_ACCESS_TOKEN'; // From Shopify Admin
  
  const mutation = `
    mutation customerAccessTokenCreate($input: CustomerAccessTokenCreateInput!) {
      customerAccessTokenCreate(input: $input) {
        customerAccessToken {
          accessToken
          expiresAt
        }
        customerUserErrors {
          code
          field
          message
        }
      }
    }
  `;
  
  const response = await fetch(`https://${shopDomain}/api/2026-01/graphql.json`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-Shopify-Storefront-Access-Token': storefrontAccessToken
    },
    body: JSON.stringify({
      query: mutation,
      variables: {
        input: { email, password }
      }
    })
  });
  
  const data = await response.json();
  
  if (data.data.customerAccessTokenCreate.customerAccessToken) {
    const token = data.data.customerAccessTokenCreate.customerAccessToken.accessToken;
    return token;
  }
  
  throw new Error('Login failed');
}
```

### Step 2: Store Token

```javascript
// After login
const token = await loginCustomer('customer@example.com', 'password');

// Store in cookie
document.cookie = `customerAccessToken=${token}; path=/; max-age=${60 * 60 * 24 * 30}; SameSite=Lax`;

// Or store in localStorage
localStorage.setItem('customerAccessToken', token);
```

### Step 3: Use Token to Check Login Status

```javascript
// Get token
function getCustomerAccessToken() {
  // Try cookie first
  const cookies = document.cookie.split(';');
  for (let cookie of cookies) {
    const [name, value] = cookie.trim().split('=');
    if (name === 'customerAccessToken') {
      return decodeURIComponent(value);
    }
  }
  
  // Try localStorage
  return localStorage.getItem('customerAccessToken');
}

// Use token
async function checkLoginAndRedirect() {
  const token = getCustomerAccessToken();
  
  if (!token) {
    window.location.href = '/account/login';
    return;
  }
  
  // Check login status with your App Proxy
  const response = await fetch(`/apps/xwan-ai-sso/check-login?customer_access_token=${token}&return_to=/dashboard`);
  const data = await response.json();
  
  if (data.isLoggedIn) {
    window.location.href = data.redirectUrl;
  } else {
    window.location.href = data.loginUrl;
  }
}
```

## Important Notes

### 1. **Storefront Access Token vs Customer Access Token**

- **Storefront Access Token**: Public token for your store (from Shopify Admin → Settings → Apps and sales channels → Storefront API)
- **Customer Access Token**: Private token for individual customers (generated per customer)

**You need BOTH:**
- Storefront Access Token: To call Storefront API (generate customer tokens)
- Customer Access Token: To authenticate as a specific customer

### 2. **Token Expiration**

Customer access tokens expire. Check `expiresAt` and refresh if needed:

```javascript
// Refresh token before it expires
async function refreshCustomerToken(token) {
  const mutation = `
    mutation customerAccessTokenRenew($customerAccessToken: String!) {
      customerAccessTokenRenew(customerAccessToken: $customerAccessToken) {
        customerAccessToken {
          accessToken
          expiresAt
        }
        userErrors {
          field
          message
        }
      }
    }
  `;
  
  // Call Storefront API...
}
```

### 3. **Customer Account API vs Storefront API**

- **Customer Account API**: New, handles authentication automatically (stores tokens in cookies)
- **Storefront API**: Legacy, requires manual token management

Most stores now use Customer Account API, which handles tokens automatically.

## Recommended Approach for Your Use Case

For your SSO implementation, use this approach:

### Option 1: Use Customer Data from Liquid (Simplest)

```liquid
{% if customer %}
  <a href="/apps/xwan-ai-sso/sso?customer_email={{ customer.email | url_param_escape }}&customer_id={{ customer.id }}&first_name={{ customer.first_name | url_param_escape }}&last_name={{ customer.last_name | url_param_escape }}">
    Go to XWAN.AI
  </a>
{% else %}
  <a href="/account/login?checkout_url=/apps/xwan-ai-sso/sso">Login</a>
{% endif %}
```

### Option 2: Get Token from Cookie (Better Security)

```javascript
// Get token from cookie (set by Customer Account API)
function getCustomerAccessToken() {
  const cookies = document.cookie.split(';');
  for (let cookie of cookies) {
    const [name, value] = cookie.trim().split('=');
    if (name === 'customerAccessToken' || name === '__customer_access_token') {
      return decodeURIComponent(value);
    }
  }
  return null;
}

// Use token
const token = getCustomerAccessToken();
if (token) {
  fetch(`/apps/xwan-ai-sso/check-login?customer_access_token=${token}`, {
    credentials: 'include'
  })
  .then(r => r.json())
  .then(data => {
    if (data.isLoggedIn) {
      window.location.href = data.redirectUrl;
    }
  });
}
```

### Option 3: App Proxy Reads from Cookie (Best)

Your App Proxy endpoint already handles this - it reads from cookie automatically:

```typescript
// In app-proxy.check-login.tsx
const cookies = request.headers.get("cookie") || "";
const cookieMatch = cookies.match(/customerAccessToken=([^;]+)/);
if (cookieMatch) {
  const customerAccessToken = cookieMatch[1];
  // Use token...
}
```

So from the frontend, you just need to:
```javascript
// Just redirect - App Proxy will read token from cookie automatically
window.location.href = '/apps/xwan-ai-sso/check-login?return_to=/dashboard';
```

## Summary

1. **Token is generated by Shopify** when customer logs in/registers
2. **Token is stored in cookie** automatically by Customer Account API
3. **Get token from cookie** in JavaScript: `document.cookie`
4. **App Proxy can read from cookie** automatically (no need to pass explicitly)
5. **For Liquid templates**, use `customer` object directly (no token needed)

The easiest approach: Let Shopify handle token management automatically, and your App Proxy will read it from cookies.
